<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸­è¥¿åˆç’§ä¸‡å¹´å† - é©¬å¾·é‡Œ 25-26 å®˜æ–¹æ ¡å†æƒå¨ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&family=Inter:wght@400;600&display=swap');
        
        body { font-family: 'Inter', 'Noto Serif SC', 'Microsoft YaHei', sans-serif; background: #f8fafc; color: #1e293b; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); }
        
        .day-card { 
            aspect-ratio: 1 / 1.35; 
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); 
            border: 1px solid #f1f5f9; 
            position: relative; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            background: white; 
            padding-top: 10px;
            cursor: pointer;
        }
        .day-card:hover { transform: translateY(-4px); z-index: 10; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); border-radius: 1rem; border-color: #fbbf24; }
        .is-today { background-color: #fffbeb; border: 2px solid #fbbf24 !important; border-radius: 1rem; }
        .day-selected { border: 2px solid #ef4444 !important; border-radius: 1rem; box-shadow: 0 0 15px rgba(239, 68, 68, 0.2); }
        
        .tag-school-off { position: absolute; top: 4px; right: 4px; font-size: 9px; background: #fcd34d; color: #92400e; padding: 0 3px; border-radius: 2px; font-weight: bold; }
        .work-tag { position: absolute; top: 4px; left: 4px; font-size: 10px; background: #94a3b8; color: white; padding: 0 3px; border-radius: 2px; font-weight: bold; }
        .rest-tag { position: absolute; top: 4px; left: 4px; font-size: 10px; background: #ef4444; color: white; padding: 0 3px; border-radius: 2px; font-weight: bold; }

        .lunar-text { font-size: 0.7rem; color: #64748b; margin-top: 2px; }
        .fest-cn { color: #dc2626; font-weight: 700; font-size: 0.65rem; }
        .fest-es { color: #7c3aed; font-weight: 700; font-size: 0.65rem; }
        .term-text { color: #059669; font-weight: 700; font-size: 0.65rem; }

        .yi { background: #e11d48; color: white; border-radius: 50%; width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; font-size: 12px; margin-right: 8px; flex-shrink: 0; font-weight: bold; }
        .ji { background: #475569; color: white; border-radius: 50%; width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; font-size: 12px; margin-right: 8px; flex-shrink: 0; font-weight: bold; }
    </style>
</head>
<body class="p-2 md:p-6">

    <div class="max-w-7xl mx-auto bg-white rounded-[2rem] shadow-2xl overflow-hidden flex flex-col md:flex-row border border-slate-200">
        <!-- å·¦ä¾§æ—¥å† -->
        <div class="flex-1 p-4 md:p-8">
            <div class="flex flex-wrap justify-between items-center mb-8 gap-4">
                <div class="flex items-center gap-6">
                    <h1 id="currentMonthDisplay" class="text-4xl font-black text-slate-800 tracking-tighter">2026å¹´ 2æœˆ</h1>
                    <div class="flex bg-slate-100 p-1 rounded-xl">
                        <select id="yearSelect" class="bg-transparent border-none font-bold text-slate-600 focus:ring-0 cursor-pointer text-sm" onchange="jumpToDate()"></select>
                        <select id="monthSelect" class="bg-transparent border-none font-bold text-slate-600 focus:ring-0 cursor-pointer text-sm" onchange="jumpToDate()"></select>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="changeMonth(-1)" class="p-3 hover:bg-slate-100 rounded-full border border-slate-200 transition-colors"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
                    <button onclick="resetToToday()" class="px-6 py-2.5 bg-slate-800 text-white rounded-xl font-bold text-sm shadow-md hover:bg-slate-700 transition-all">ä»Šæ—¥</button>
                    <button onclick="changeMonth(1)" class="p-3 hover:bg-slate-100 rounded-full border border-slate-200 transition-colors"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg></button>
                </div>
            </div>

            <div class="calendar-grid mb-2">
                <div class="py-2 text-center text-xs font-black text-red-500 uppercase">æ—¥</div>
                <div class="py-2 text-center text-xs font-black text-slate-400 uppercase">ä¸€</div>
                <div class="py-2 text-center text-xs font-black text-slate-400 uppercase">äºŒ</div>
                <div class="py-2 text-center text-xs font-black text-slate-400 uppercase">ä¸‰</div>
                <div class="py-2 text-center text-xs font-black text-slate-400 uppercase">å››</div>
                <div class="py-2 text-center text-xs font-black text-slate-400 uppercase">äº”</div>
                <div class="py-2 text-center text-xs font-black text-red-500 uppercase">å…­</div>
            </div>
            <div id="calendarDays" class="calendar-grid gap-1.5"></div>
        </div>

        <!-- å³ä¾§é¢æ¿ -->
        <div id="sidePanel" class="w-full md:w-[420px] bg-slate-50 border-l border-slate-100 p-8 overflow-y-auto max-h-[95vh]">
            <div class="text-center mb-6">
                <div id="sideDate" class="text-8xl font-black text-slate-800 mb-2 leading-none">17</div>
                <div id="sideMonthYear" class="text-slate-500 font-bold uppercase tracking-widest text-sm">February 2026</div>
                <div id="sideWeek" class="mt-4 inline-block px-6 py-1.5 bg-red-500 text-white rounded-full text-xs font-black shadow-sm">æ˜ŸæœŸäºŒ</div>
            </div>

            <div class="space-y-5">
                <!-- èŠ‚å‡æ—¥æé†’ -->
                <div id="sideHolidayBox" class="hidden bg-amber-50 p-4 rounded-2xl border border-amber-200 shadow-sm">
                    <div id="sideHolidayText" class="text-base font-bold text-amber-900 leading-tight space-y-1"></div>
                </div>

                <!-- å†œå†åŸºç¡€ä¿¡æ¯ -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-16 h-16 opacity-5 pointer-events-none">
                        <svg viewBox="0 0 100 100" fill="currentColor" class="text-red-600"><path d="M50 0 L100 50 L50 100 L0 50 Z"/></svg>
                    </div>
                    <div class="text-xs font-black text-slate-400 mb-3 flex justify-between uppercase">
                        <span>å†œå† LUNAR</span>
                        <span id="sideGZYear" class="text-red-600 font-bold"></span>
                    </div>
                    <div id="sideLunarMain" class="text-3xl font-black text-slate-800 mb-1">æ­£æœˆåˆä¸€</div>
                    <div id="sideGZFull" class="text-sm text-slate-500 font-medium">ä¸™åˆå¹´ åºšå¯…æœˆ è¾›æœªæ—¥</div>
                    <div id="sideChong" class="inline-block mt-3 px-3 py-1 bg-red-50 text-red-600 text-xs font-bold rounded-lg border border-red-100">å†²ç‰›(ä¹™ä¸‘) ç…è¥¿</div>
                </div>

                <!-- å®œå¿Œé¢æ¿ -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm">
                        <div class="flex items-center mb-3"><span class="yi">å®œ</span><span class="text-xs font-black text-slate-400 uppercase">Appropriate</span></div>
                        <div id="sideYi" class="text-sm text-slate-700 font-bold leading-relaxed min-h-[3rem]">ç¥­ç¥€ã€ç¥ˆç¦</div>
                    </div>
                    <div class="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm">
                        <div class="flex items-center mb-3"><span class="ji">å¿Œ</span><span class="text-xs font-black text-slate-400 uppercase">Avoid</span></div>
                        <div id="sideJi" class="text-sm text-slate-700 font-bold leading-relaxed min-h-[3rem]">å¼€å¸‚ã€å®‰è‘¬</div>
                    </div>
                </div>

                <!-- é¢å¤–æé†’ (èŠ‚æ°”/æ•°ä¹/ä¸‰ä¼) -->
                <div id="sideExtraBox" class="bg-blue-50 p-4 rounded-2xl border border-blue-100">
                    <div id="sideExtraText" class="text-xs font-bold text-blue-800 flex flex-col gap-1">
                        <div class="flex items-center gap-2">
                             <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z"/></svg>
                             <span id="sideTermInfo">ä»Šæ—¥æ— ç‰¹æ®ŠèŠ‚æ°”æé†’</span>
                        </div>
                        <div id="sideShujiuInfo" class="text-blue-600 font-bold pl-6"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- æ ¸å¿ƒæ•°æ® ---
        const LUNAR_INFO = [0x04bd8,0x04ae0,0x0a570,0x054d5,0x0d260,0x0d950,0x16554,0x056a0,0x09ad0,0x055d2,0x04ae0,0x0a5b6,0x0a4d0,0x0d250,0x1d255,0x0b540,0x0d6a0,0x0ada2,0x095b0,0x14977,0x04970,0x0a4b0,0x0b4b5,0x06a50,0x06d40,0x1ab54,0x02b60,0x09570,0x052f2,0x04970,0x06566,0x0d4a0,0x0ea50,0x06e95,0x05ad0,0x02b60,0x186e3,0x092e0,0x1c8d7,0x0c950,0x0d4a0,0x1d8a6,0x0b550,0x056a0,0x1a5b4,0x025d0,0x092d0,0x0d2b2,0x0a950,0x0b557,0x06ca0,0x0b550,0x15355,0x04da0,0x0a5d0,0x14573,0x052d0,0x0a9a8,0x0e950,0x06aa0,0x0aea6,0x0ab50,0x04b60,0x0aae4,0x0a570,0x05260,0x0f263,0x0d950,0x05b57,0x056a0,0x096d0,0x04dd5,0x04ad0,0x0a4d0,0x0d4d4,0x0d250,0x0d250,0x0b540,0x0b5a0,0x195a6,0x095b0,0x049b0,0x0a974,0x0a4b0,0x0b27a,0x06a50,0x06d40,0x0af46,0x0ab60,0x09570,0x04af5];
        const SOLAR_TERMS = ["å°å¯’", "å¤§å¯’", "ç«‹æ˜¥", "é›¨æ°´", "æƒŠè›°", "æ˜¥åˆ†", "æ¸…æ˜", "è°·é›¨", "ç«‹å¤", "å°æ»¡", "èŠ’ç§", "å¤è‡³", "å°æš‘", "å¤§æš‘", "ç«‹ç§‹", "å¤„æš‘", "ç™½éœ²", "ç§‹åˆ†", "å¯’éœ²", "éœœé™", "ç«‹å†¬", "å°é›ª", "å¤§é›ª", "å†¬è‡³"];
        const T_GAN = ["ç”²", "ä¹™", "ä¸™", "ä¸", "æˆŠ", "å·±", "åºš", "è¾›", "å£¬", "ç™¸"];
        const D_ZHI = ["å­", "ä¸‘", "å¯…", "å¯", "è¾°", "å·³", "åˆ", "æœª", "ç”³", "é…‰", "æˆŒ", "äº¥"];
        const SX = ["é¼ ", "ç‰›", "è™", "å…”", "é¾™", "è›‡", "é©¬", "ç¾Š", "çŒ´", "é¸¡", "ç‹—", "çŒª"];
        const LUNAR_MONTHS = ["æ­£æœˆ", "äºŒæœˆ", "ä¸‰æœˆ", "å››æœˆ", "äº”æœˆ", "å…­æœˆ", "ä¸ƒæœˆ", "å…«æœˆ", "ä¹æœˆ", "åæœˆ", "å†¬æœˆ", "è…Šæœˆ"];
        const LUNAR_DAYS = ["åˆä¸€", "åˆäºŒ", "åˆä¸‰", "åˆå››", "åˆäº”", "åˆå…­", "åˆä¸ƒ", "åˆå…«", "åˆä¹", "åˆå", "åä¸€", "åäºŒ", "åä¸‰", "åå››", "åäº”", "åå…­", "åä¸ƒ", "åå…«", "åä¹", "äºŒå", "å»¿ä¸€", "å»¿äºŒ", "å»¿ä¸‰", "å»¿å››", "å»¿äº”", "å»¿å…­", "å»¿ä¸ƒ", "å»¿å…«", "å»¿ä¹", "ä¸‰å"];
        const ST_DATA = [0, 21208, 42467, 63836, 85337, 107014, 128867, 150921, 173149, 195551, 218072, 240693, 263343, 285961, 308463, 330788, 352819, 374543, 395920, 416905, 437485, 457653, 477414, 496773];

        // 2025-2026å¹´ä¸­å›½èŠ‚å‡æ—¥
        const CN_HOLIDAY = { 
            "2025-10-01": { name: "å›½åº†èŠ‚", type: "rest" },
            "2026-01-01": { name: "å…ƒæ—¦", type: "rest" }, 
            "2026-02-16": { name: "é™¤å¤•", type: "rest" }, 
            "2026-02-17": { name: "æ˜¥èŠ‚", type: "rest" }, 
            "2026-02-18": { name: "åˆäºŒ", type: "rest" }, 
            "2026-02-19": { name: "åˆä¸‰", type: "rest" }, 
            "2026-02-20": { name: "åˆå››", type: "rest" }, 
            "2026-02-21": { name: "åˆäº”", type: "rest" }, 
            "2026-02-22": { name: "åˆå…­", type: "rest" }, 
            "2026-04-05": { name: "æ¸…æ˜èŠ‚", type: "rest" }, 
            "2026-05-01": { name: "åŠ³åŠ¨èŠ‚", type: "rest" } 
        };

        // é©¬å¾·é‡Œ 25-26 å®˜æ–¹æ ¡å†ï¼šéæ•™å­¦æ—¥ (Otros dÃ­as sin actividad lectiva)
        const MADRID_NO_LECTIVO = { 
            "2025-10-13": "éæ•™å­¦æ—¥ (Puente Pilar)",
            "2025-11-03": "éæ•™å­¦æ—¥ (Puente Todos los Santos)",
            "2026-01-07": "éæ•™å­¦æ—¥ (ExtensiÃ³n Navidad)",
            "2026-03-27": "éæ•™å­¦æ—¥ (Previo Semana Santa)",
            "2026-04-06": "éæ•™å­¦æ—¥ (Lunes Pascua no lectivo)"
        };

        // å®˜æ–¹æŒ‡å®šå‡æœŸåŒºé—´é€»è¾‘
        function getMadridSpecialInfo(y, m, d) {
            const date = new Date(y, m, d);
            const time = date.getTime();
            
            // åœ£è¯å‡æœŸ (Navidad): 2025-12-20 åˆ° 2026-01-06
            const xMasStart = new Date(2025, 11, 20).getTime();
            const xMasEnd = new Date(2026, 0, 6).getTime();
            if (time >= xMasStart && time <= xMasEnd) return "åœ£è¯å‡æœŸ (Navidad)";

            // åœ£å‘¨å‡æœŸ (Semana Santa): 2026-03-28 åˆ° 2026-04-05
            const easterStart = new Date(2026, 2, 28).getTime();
            const easterEnd = new Date(2026, 3, 5).getTime();
            if (time >= easterStart && time <= easterEnd) return "åœ£å‘¨å‡æœŸ (Semana Santa)";

            // æš‘å‡èµ·æ­¢
            const summerStart = new Date(2026, 5, 20).getTime();
            if (y === 2026 && time >= summerStart && m < 8) return "æš‘å‡ (Vacaciones de Verano)";

            return MADRID_NO_LECTIVO[`${y}-${(m+1).toString().padStart(2,'0')}-${d.toString().padStart(2,'0')}`] || null;
        }

        const ES_FESTS = { 
            "2025-12-8": "Inmaculada ConcepciÃ³n",
            "2026-1-1": "AÃ±o Nuevo", 
            "2026-1-6": "EpifanÃ­a del SeÃ±or", 
            "2026-3-19": "San JosÃ©", 
            "2026-4-2": "Jueves Santo", 
            "2026-4-3": "Viernes Santo", 
            "2026-5-1": "Fiesta del Trabajo", 
            "2026-5-2": "Fiesta Comunidad de Madrid" 
        };

        const YI_LIST = ["ç¥­ç¥€", "ç¥ˆç¦", "æ±‚å—£", "å¼€å…‰", "è§£é™¤", "ä¼æœ¨", "å‡ºç«", "å…¥å®…", "ç§»å¾™", "å®‰åºŠ", "ä¿®é€ ", "åŠ¨åœŸ", "ä¸Šæ¢", "çº³ç•œ", "å®‰è‘¬", "ä¿®åŸ", "ç«‹ç¢‘", "ç ´åœŸ", "æˆæœ", "é™¤æœ", "ç§»æŸ©", "å¯é’»"];
        const JI_LIST = ["å¼€å¸‚", "äº¤æ˜“", "æŒ‚åŒ¾", "æ˜äº•", "ä¹˜èˆ¹", "è¯è®¼", "ç½®äº§", "ä½œç¶", "ç»ç»œ", "æ ½ç§", "å®‰é—¨", "è¡Œä¸§", "å‡ºè¡Œ", "å«å¨¶", "å…¥æ®“", "åŠ¨åœŸ"];

        // --- æ ¸å¿ƒç®—æ³• ---
        function getLunar(year, month, day) {
            let offset = (Date.UTC(year, month, day) - Date.UTC(1900, 0, 31)) / 86400000;
            let i, leap = 0, temp = 0;
            for (i = 1900; i < 2101 && offset > 0; i++) { temp = getLunarYearDays(i); offset -= temp; }
            if (offset < 0) { offset += temp; i--; }
            const lunarYear = i;
            leap = getLeapMonth(i);
            let isLeap = false;
            for (i = 1; i < 13 && offset > 0; i++) {
                if (leap > 0 && i === (leap + 1) && !isLeap) { --i; isLeap = true; temp = getLeapDays(lunarYear); }
                else { temp = getMonthDays(lunarYear, i); }
                if (isLeap && i === (leap + 1)) isLeap = false;
                offset -= temp;
            }
            if (offset < 0) { offset += temp; i--; }
            return { y: lunarYear, m: i, d: Math.floor(offset + 1), isLeap: isLeap };
        }
        function getLunarYearDays(y) { let sum = 348; for (let i = 0x8000; i > 0x8; i >>= 1) sum += (LUNAR_INFO[y - 1900] & i) ? 1 : 0; return sum + getLeapDays(y); }
        function getLeapMonth(y) { return LUNAR_INFO[y - 1900] & 0xf; }
        function getLeapDays(y) { return getLeapMonth(y) ? ((LUNAR_INFO[y - 1900] & 0x10000) ? 30 : 29) : 0; }
        function getMonthDays(y, m) { return (LUNAR_INFO[y - 1900] & (0x10000 >> m)) ? 30 : 29; }
        
        function getTermDate(y, n) {
            const time = (31556925974.7 * (y - 1900) + ST_DATA[n] * 60000) + Date.UTC(1900, 0, 6, 2, 5);
            return new Date(time);
        }

        function getGZ(year, month, day) {
            const date = new Date(year, month, day);
            const baseDate = new Date(1900, 0, 31);
            const offsetDays = Math.floor((date.getTime() - baseDate.getTime()) / 86400000);
            const yearGZ = T_GAN[(year - 4) % 10] + D_ZHI[(year - 4) % 12];
            const monthGZ = T_GAN[(year * 12 + month + 12 + 1) % 10] + D_ZHI[(month + 2) % 12];
            const dayGZ = T_GAN[(offsetDays + 40) % 10] + D_ZHI[(offsetDays + 14) % 12];
            return { y: yearGZ, m: monthGZ, d: dayGZ, offset: offsetDays };
        }

        function getShujiu(date) {
            const year = date.getFullYear();
            let dongzhi = getTermDate(year - 1, 23);
            if (date < dongzhi) dongzhi = getTermDate(year - 2, 23);
            const diff = Math.floor((date.getTime() - dongzhi.setHours(0,0,0,0)) / 86400000);
            if (diff >= 0 && diff < 81) {
                const jiuNames = ["ä¸€ä¹", "äºŒä¹", "ä¸‰ä¹", "å››ä¹", "äº”ä¹", "å…­ä¹", "ä¸ƒä¹", "å…«ä¹", "ä¹ä¹"];
                return `${jiuNames[Math.floor(diff/9)]} ç¬¬${(diff%9)+1}å¤©`;
            }
            return null;
        }

        function getSanfu(date) {
            const year = date.getFullYear();
            const xiazhi = getTermDate(year, 11);
            const baseDate = new Date(1900, 0, 31);
            const isGeng = (d) => (Math.floor((d.getTime() - baseDate.getTime()) / 86400000) + 40) % 10 === 6;
            let gCount = 0, firstGeng = new Date(xiazhi);
            while(gCount < 3) { if(isGeng(firstGeng)) gCount++; if(gCount<3) firstGeng.setDate(firstGeng.getDate()+1); }
            const chuFu = new Date(firstGeng);
            const zhongFu = new Date(chuFu); zhongFu.setDate(chuFu.getDate()+10);
            const liqiu = getTermDate(year, 14);
            let moFu = new Date(liqiu);
            while(!isGeng(moFu)) moFu.setDate(moFu.getDate()+1);
            const t = date.setHours(0,0,0,0);
            if(t >= chuFu.getTime() && t < chuFu.getTime()+10*86400) return `åˆä¼ ç¬¬${Math.floor((t-chuFu)/86400000)+1}å¤©`;
            if(t >= zhongFu.getTime() && t < moFu.getTime()) return `ä¸­ä¼ ç¬¬${Math.floor((t-zhongFu)/86400000)+1}å¤©`;
            if(t >= moFu.getTime() && t < moFu.getTime()+10*86400) return `æœ«ä¼ ç¬¬${Math.floor((t-moFu)/86400000)+1}å¤©`;
            return null;
        }

        let viewDate = new Date();
        let selectedDate = new Date();

        function render() {
            const y = viewDate.getFullYear(), m = viewDate.getMonth();
            document.getElementById('currentMonthDisplay').innerText = `${y}å¹´ ${m + 1}æœˆ`;
            const firstDay = new Date(y, m, 1).getDay();
            const lastDate = new Date(y, m + 1, 0).getDate();
            const prevLastDate = new Date(y, m, 0).getDate();
            
            const container = document.getElementById('calendarDays');
            container.innerHTML = '';
            const terms = {};
            for (let i = 0; i < 24; i++) {
                const tDate = getTermDate(y, i);
                if (tDate.getMonth() === m) terms[tDate.getDate()] = SOLAR_TERMS[i];
            }

            for (let i = firstDay; i > 0; i--) createDay(prevLastDate - i + 1, true);
            for (let d = 1; d <= lastDate; d++) {
                const isoStr = `${y}-${(m+1).toString().padStart(2,'0')}-${d.toString().padStart(2,'0')}`;
                const schoolOff = getMadridSpecialInfo(y, m, d);
                createDay(d, false, new Date().toDateString() === new Date(y,m,d).toDateString(), selectedDate.toDateString() === new Date(y,m,d).toDateString(), terms[d], CN_HOLIDAY[isoStr], schoolOff, ES_FESTS[`${y}-${m+1}-${d}`], getLunar(y, m, d), y, m);
            }
        }

        function createDay(d, isPad, isToday, isSelected, term, cnHoliday, schoolOff, esFest, lunar, y, m) {
            const div = document.createElement('div');
            div.className = `day-card ${isPad ? 'opacity-20 pointer-events-none' : ''} ${isToday ? 'is-today' : ''} ${isSelected ? 'day-selected' : ''}`;
            if (!isPad) div.onclick = () => { selectedDate = new Date(y, m, d); updateAlmanac(); render(); };
            
            let html = "";
            if (cnHoliday) html += `<div class="${cnHoliday.type === 'work' ? 'work-tag' : 'rest-tag'}">${cnHoliday.type === 'work' ? 'ç­' : 'ä¼‘'}</div>`;
            if (schoolOff) html += `<div class="tag-school-off" title="${schoolOff}">æ ¡ä¼‘</div>`;
            
            const isRedDay = cnHoliday?.type === 'rest' || esFest || new Date(y,m,d).getDay() === 0 || new Date(y,m,d).getDay() === 6;
            html += `<span class="text-xl font-black ${isRedDay ? 'text-red-500' : 'text-slate-800'}">${d}</span>`;
            if (cnHoliday) html += `<span class="fest-cn text-[0.6rem] truncate px-1">${cnHoliday.name}</span>`;
            else if (esFest) html += `<span class="fest-es text-[0.6rem] font-bold truncate px-1">${esFest.split(' ')[0]}</span>`;
            else if (term) html += `<span class="term-text text-[0.6rem]">${term}</span>`;
            else if (lunar) html += `<span class="lunar-text text-[0.6rem]">${lunar.d === 1 ? LUNAR_MONTHS[lunar.m-1] : LUNAR_DAYS[lunar.d-1]}</span>`;
            
            div.innerHTML = html;
            document.getElementById('calendarDays').appendChild(div);
        }

        function updateAlmanac() {
            const y = selectedDate.getFullYear(), m = selectedDate.getMonth(), d = selectedDate.getDate();
            const iso = `${y}-${(m+1).toString().padStart(2,'0')}-${d.toString().padStart(2,'0')}`;
            const lunar = getLunar(y, m, d), gz = getGZ(y, m, d);
            const esFest = ES_FESTS[`${y}-${m+1}-${d}`], cnHol = CN_HOLIDAY[iso], schoolOff = getMadridSpecialInfo(y, m, d);
            
            document.getElementById('sideDate').innerText = d;
            document.getElementById('sideMonthYear').innerText = selectedDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            document.getElementById('sideWeek').innerText = "æ˜ŸæœŸ" + ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"][selectedDate.getDay()];
            document.getElementById('sideLunarMain').innerText = (lunar.isLeap ? "é—°" : "") + LUNAR_MONTHS[lunar.m-1] + LUNAR_DAYS[lunar.d-1];
            document.getElementById('sideGZYear').innerText = `${gz.y} ${SX[(lunar.y - 4) % 12]}å¹´`;
            document.getElementById('sideGZFull').innerText = `${gz.y}å¹´ ${gz.m}æœˆ ${gz.d}æ—¥`;
            
            const seed = gz.offset || 0;
            document.getElementById('sideYi').innerText = [YI_LIST[seed % YI_LIST.length], YI_LIST[(seed * 3 + 2) % YI_LIST.length]].join('ã€');
            document.getElementById('sideJi').innerText = [JI_LIST[seed % JI_LIST.length], JI_LIST[(seed * 7 + 1) % JI_LIST.length]].join('ã€');
            document.getElementById('sideChong').innerText = `å†²${D_ZHI[((seed+14)%12+6)%12]} ç…${["åŒ—", "ä¸œ", "å—", "è¥¿"][(seed+14)%4]}`;

            const holBox = document.getElementById('sideHolidayBox');
            if (esFest || cnHol || schoolOff) {
                holBox.classList.remove('hidden');
                let info = "";
                if (esFest) info += `<div class="text-purple-700">ğŸ‡ªğŸ‡¸ å…¬ä¼—å‡æœŸ: ${esFest}</div>`;
                if (schoolOff) info += `<div class="text-amber-700 font-bold">ğŸ« é©¬å¾·é‡Œæ ¡ä¼‘: ${schoolOff}</div>`;
                if (cnHol) info += `<div class="text-red-700">ğŸ‡¨ğŸ‡³ ä¸­å›½èŠ‚å‡æ—¥: ${cnHol.name}</div>`;
                document.getElementById('sideHolidayText').innerHTML = info;
            } else holBox.classList.add('hidden');

            let termInfo = "ä»Šæ—¥æ— ç‰¹æ®ŠèŠ‚æ°”æé†’";
            for (let i = 0; i < 24; i++) {
                const tDate = getTermDate(y, i);
                if (tDate.getDate() === d && tDate.getMonth() === m) { termInfo = `ä»Šæ—¥èŠ‚æ°”ï¼š${SOLAR_TERMS[i]}`; break; }
            }
            document.getElementById('sideTermInfo').innerText = termInfo;
            
            const sj = getShujiu(selectedDate), sf = getSanfu(selectedDate);
            document.getElementById('sideShujiuInfo').innerHTML = (sj ? `<span class="bg-blue-100 px-2 py-0.5 rounded">${sj}</span>` : "") + 
                                                               (sf ? `<span class="bg-orange-100 px-2 py-0.5 rounded ml-2">${sf}</span>` : "");
        }

        function initSelectors() {
            const ys = document.getElementById('yearSelect'), ms = document.getElementById('monthSelect');
            for (let i = 2025; i <= 2027; i++) ys.add(new Option(i + " å¹´", i, false, i === 2026));
            for (let i = 0; i < 12; i++) ms.add(new Option((i + 1) + " æœˆ", i, false, i === viewDate.getMonth()));
        }
        function changeMonth(v) { viewDate.setMonth(viewDate.getMonth() + v); updateSelectors(); render(); }
        function jumpToDate() { viewDate = new Date(document.getElementById('yearSelect').value, document.getElementById('monthSelect').value, 1); render(); }
        function updateSelectors() { document.getElementById('yearSelect').value = viewDate.getFullYear(); document.getElementById('monthSelect').value = viewDate.getMonth(); }
        function resetToToday() { viewDate = new Date(); selectedDate = new Date(); updateSelectors(); updateAlmanac(); render(); }
        window.onload = () => { initSelectors(); resetToToday(); };
    </script>
</body>
</html>
